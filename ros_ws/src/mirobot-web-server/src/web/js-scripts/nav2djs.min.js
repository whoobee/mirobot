var NAV2D=NAV2D||{REVISION:"0.5.0-SNAPSHOT"};NAV2D.resizeMap=function(e,o,t){return e||(e={width:t.width,height:t.height,x:t.pose.position.x,y:t.pose.position.y},o.scaleToDimensions(t.width,t.height),o.shift(t.pose.position.x,t.pose.position.y)),e.width===t.width&&e.height===t.height||(o.scaleToDimensions(t.width,t.height),e.width=t.width,e.height=t.height),e.x===t.pose.position.x&&e.y===t.pose.position.y||(o.shift((t.pose.position.x-e.x)/1,(t.pose.position.y-e.y)/1),e.x=t.pose.position.x,e.y=t.pose.position.y),e},NAV2D.OccupancyGridClientNav=function(e){var o=(e=e||{}).ros,t=e.tfClient||null,a=e.topic||"map",i=e.robot_pose||"/robot_pose",n=e.continuous,r=e.serverName||"/move_base",s=e.actionName||"move_base_msgs/MoveBaseAction",l=e.rootObject||new createjs.Container,c=e.viewer,g=e.withOrientation||!1,p=e.image||!1,h=null,m=new ROS2D.OccupancyGridClient({ros:o,rootObject:l,continuous:n,topic:a});new NAV2D.Navigator({ros:o,tfClient:t,serverName:r,actionName:s,robot_pose:i,rootObject:l,withOrientation:g,image:p});m.on("change",function(){h=NAV2D.resizeMap(h,c,m.currentGrid)})},NAV2D.Navigator=function(e){var o=this,t=(e=e||{}).ros,a=e.tfClient||null,i=e.robot_pose||"/robot_pose",n=e.serverName||"/move_base",r=e.actionName||"move_base_msgs/MoveBaseAction",s=e.withOrientation||!1,l=e.image;this.rootObject=e.rootObject||new createjs.Container,this.goalMarker=null;var c,g=new ROSLIB.ActionClient({ros:t,actionName:r,serverName:n});function p(e){var t=new ROSLIB.Goal({actionClient:g,goalMessage:{target_pose:{header:{frame_id:"map"},pose:e}}});t.send(),o.currentGoal=t,null===o.goalMarker&&(l&&ROS2D.hasOwnProperty("ImageNavigator")?o.goalMarker=new ROS2D.ImageNavigator({size:2.5,image:l,alpha:.7,pulse:!0}):o.goalMarker=new ROS2D.NavigationArrow({size:15,strokeSize:1,fillColor:createjs.Graphics.getRGB(255,64,128,.66),pulse:!0}),o.rootObject.addChild(o.goalMarker)),o.goalMarker.x=e.position.x,o.goalMarker.y=-e.position.y,o.goalMarker.rotation=c.rosQuaternionToGlobalTheta(e.orientation),o.goalMarker.scaleX=1/c.scaleX,o.goalMarker.scaleY=1/c.scaleY,t.on("result",function(){o.rootObject.removeChild(o.goalMarker)})}this.cancelGoal=function(){void 0!==o.currentGoal&&o.currentGoal.cancel()},c=o.rootObject instanceof createjs.Stage?o.rootObject:o.rootObject.getStage();var h=null;(h=l&&ROS2D.hasOwnProperty("ImageNavigator")?new ROS2D.ImageNavigator({size:2.5,image:l,pulse:!0}):new ROS2D.NavigationArrow({size:25,strokeSize:1,fillColor:createjs.Graphics.getRGB(255,128,0,.66),pulse:!0})).visible=!1,this.rootObject.addChild(h);var m=!1,u=function(e,o){h.x=e.x,h.y=-e.y,m||(h.scaleX=1/c.scaleX,h.scaleY=1/c.scaleY,m=!0),h.rotation=c.rosQuaternionToGlobalTheta(o),h.visible=!0};null!==a?a.subscribe(i,function(e){u(e.translation,e.rotation)}):new ROSLIB.Topic({ros:t,name:i,messageType:"geometry_msgs/Pose",throttle_rate:100}).subscribe(function(e){u(e.position,e.orientation)});if(!1===s)this.rootObject.addEventListener("dblclick",function(e){var o=c.globalToRos(e.stageX,e.stageY);p(new ROSLIB.Pose({position:new ROSLIB.Vector3(o)}))});else{var v=null,O=null,w=0,b=0,d=null,N=!1,f=0,R=0,S=function(e,t){if("down"===t)v=c.globalToRos(e.stageX,e.stageY),O=new ROSLIB.Vector3(v),N=!0;else if("move"===t){if(o.rootObject.removeChild(d),!0===N){var a=c.globalToRos(e.stageX,e.stageY),i=new ROSLIB.Vector3(a);d=l&&ROS2D.hasOwnProperty("ImageNavigator")?new ROS2D.ImageNavigator({size:2.5,image:l,alpha:.7,pulse:!1}):new ROS2D.NavigationArrow({size:25,strokeSize:1,fillColor:createjs.Graphics.getRGB(0,255,0,.66),pulse:!1}),f=i.x-O.x,R=i.y-O.y,w=Math.atan2(f,R),(b=w*(180/Math.PI))>=0&&b<=180?b+=270:b-=90,d.x=O.x,d.y=-O.y,d.rotation=b,d.scaleX=1/c.scaleX,d.scaleY=1/c.scaleY,o.rootObject.addChild(d)}}else if(N){N=!1;var n=c.globalToRos(e.stageX,e.stageY),r=new ROSLIB.Vector3(n);f=r.x-O.x,R=r.y-O.y,(w=Math.atan2(f,R))>=0&&w<=Math.PI?w+=3*Math.PI/2:w-=Math.PI/2;var s=Math.sin(-w/2),g=Math.cos(-w/2),h=new ROSLIB.Quaternion({x:0,y:0,z:s,w:g});p(new ROSLIB.Pose({position:O,orientation:h}))}};this.rootObject.addEventListener("stagemousedown",function(e){S(e,"down")}),this.rootObject.addEventListener("stagemousemove",function(e){S(e,"move")}),this.rootObject.addEventListener("stagemouseup",function(e){S(e,"up")})}},NAV2D.ImageMapClientNav=function(e){var o=(e=e||{}).ros,t=e.tfClient||null,a=e.topic||"/map_metadata",i=e.robot_pose||"/robot_pose",n=e.image_map,r=e.image||!1,s=e.serverName||"/move_base",l=e.actionName||"move_base_msgs/MoveBaseAction",c=e.rootObject||new createjs.Container,g=e.viewer,p=e.withOrientation||!1,h=null,m=new ROS2D.ImageMapClient({ros:o,rootObject:c,topic:a,image:n});new NAV2D.Navigator({ros:o,tfClient:t,serverName:s,actionName:l,robot_pose:i,rootObject:c,withOrientation:p,image:r});m.on("change",function(){h=NAV2D.resizeMap(h,g,m.currentGrid)})};